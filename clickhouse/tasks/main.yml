---
- name: "Install dependencies"
  ansible.builtin.dnf:
    state: present
    name:
      - curl
      - gnupg
      - yum-utils
  when: clickhouse_install_dependencies

- name: "Add ClickHouse repository"
  block:
    - name: "Add repository GPG key"
      ansible.builtin.rpm_key:
        state: present
        key: https://packages.clickhouse.com/rpm/stable/repodata/repomd.xml.key
    - name: "Add repository"
      ansible.builtin.yum_repository:
        name: clickhouse
        description: ClickHouse repository
        enabled: yes
        gpgcheck: yes
        baseurl: https://packages.clickhouse.com/rpm/stable/
        gpgkey: https://packages.clickhouse.com/rpm/stable/repodata/repomd.xml.key

- name: "Install ClickHouse packages"
  ansible.builtin.dnf:
    disable_gpg_check: yes
    update_cache: yes
    state: present
    name:
      - clickhouse-server
      - clickhouse-client

- name: "Create config directory"
  ansible.builtin.file:
    path: "/etc/clickhouse-server/config.d"
    state: directory
    owner: clickhouse
    group: clickhouse
    mode: "0755"

- name: "Configure CORS and network"
  ansible.builtin.template:
    src: cors.xml.j2
    dest: /etc/clickhouse-server/config.d/cors.xml
    owner: clickhouse
    group: clickhouse
    mode: "0644"

- name: "Start and enable ClickHouse service"
  ansible.builtin.systemd:
    name: clickhouse-server
    state: started
    enabled: yes
    daemon_reload: yes

- name: "Wait for ClickHouse to start"
  ansible.builtin.wait_for:
    host: "{{ ansible_host }}"
    state: started
    port: "{{ clickhouse_http_port }}"
    delay: 10
    timeout: 60

- name: "Create database and table"
  ansible.builtin.shell: |
    clickhouse-client --query="CREATE DATABASE IF NOT EXISTS {{ clickhouse_database }}"
    clickhouse-client --query="CREATE TABLE IF NOT EXISTS {{ clickhouse_database }}.{{ clickhouse_table }} (
      timestamp DateTime,
      message String,
      host String,
      source String
    ) ENGINE = MergeTree()
    PARTITION BY toYYYYMM(timestamp)
    ORDER BY (timestamp, host)"
  register: db_creation
  failed_when: db_creation.rc != 0 and "already exists" not in db_creation.stderr
  changed_when: db_creation.rc == 0

- name: "Get ClickHouse version"
  ansible.builtin.shell: clickhouse-client --query="SELECT version()"
  register: clickhouse_version

- name: "Display ClickHouse version"
  ansible.builtin.debug:
    msg: "ClickHouse version: {{ clickhouse_version.stdout }}"
